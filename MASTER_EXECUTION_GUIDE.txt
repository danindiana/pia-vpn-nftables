#!/bin/bash
# PIA VPN nftables Implementation - Master Execution Guide
# This document describes how to execute all phases

cat << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                    â•‘
â•‘     PIA VPN v3.7.0 nftables Implementation                         â•‘
â•‘     Complete 7-Phase Deployment Guide                             â•‘
â•‘                                                                    â•‘
â•‘     System Status:                                                 â•‘
â•‘     âœ“ OS: Linux                                                    â•‘
â•‘     âœ“ Firewall: iptables-nft (nftables wrapper)                   â•‘
â•‘     âœ“ PIA Version: 3.7.0+08412                                     â•‘
â•‘     âœ“ Current State: Disconnected                                  â•‘
â•‘                                                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

IMPLEMENTATION PHASES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Phase 0: PRE-FLIGHT CHECKS âœ… COMPLETE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Status: PASSED
  Results:
    â€¢ iptables version: 1.8.7 (using nftables wrapper)
    â€¢ PIA version: 3.7.0+08412 (installed)
    â€¢ PIA connection: Disconnected (ready for setup)
    â€¢ Kill Switch: Not configured
    â€¢ Allow LAN: Enabled
  
  Next: Proceed to Phase 1

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Phase 1: COMPREHENSIVE BACKUP (5 minutes)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  What: Back up all current network configuration
  Why: Recovery fallback if something goes wrong
  
  File: PHASE1-backup.sh
  Usage: sudo bash PHASE1-backup.sh
  
  This will backup:
    âœ“ nftables ruleset
    âœ“ iptables rules
    âœ“ Routing table
    âœ“ systemd-resolved configuration
    âœ“ UFW configuration (if present)
    âœ“ PIA settings
    âœ“ Install emergency recovery script
  
  Output: ~/pia-backup-YYYYMMDD-HHMMSS/
  
  âš ï¸  IMPORTANT: RUN WITH SUDO

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Phase 2: MULTI-INTERFACE ROUTING CHECK (2 minutes)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  What: Check for weighted nexthop routes that might conflict
  
  File: PHASE2-routing-check.sh
  Usage: bash PHASE2-routing-check.sh
  
  If multi-interface routing is detected:
    Option A: Simplify to single route (recommended)
              â†’ sudo bash multi-interface-routing.sh
    Option B: Keep current routing (may cause issues)
    Option C: Manual configuration
  
  Current status: Will be checked when you run the script

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Phase 3: CONFIGURE PIA SETTINGS (2 minutes)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  What: Disable PIA's built-in firewall, enable LAN access
  Why: PIA's firewall doesn't work with nftables
  
  File: PHASE3-pia-config.sh
  Usage: bash PHASE3-pia-config.sh
  
  This will:
    â€¢ Set killswitch off (we'll use nftables instead)
    â€¢ Set allowlan true (maintain local network access)
    â€¢ Apply settings
  
  No sudo required - just piactl commands

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Phase 4: INSTALL NFTABLES KILL SWITCH (15 minutes)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  What: Generate and apply custom nftables rules
  Why: Replace PIA's broken firewall with native nftables
  
  File: PHASE4-nftables-install.sh
  Usage: sudo bash PHASE4-nftables-install.sh
  
  This will:
    â€¢ Detect physical network interfaces
    â€¢ Detect PIA server IP ranges dynamically
    â€¢ Detect your LAN subnet
    â€¢ Generate nftables rules
    â€¢ Validate syntax before applying
    â€¢ Create backup before changes
    â€¢ Make rules persistent
  
  âš ï¸  IMPORTANT: RUN WITH SUDO
  âš ï¸  You'll be prompted to confirm rules before applying

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Phase 5: TEST VPN CONNECTION (5 minutes)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  What: Connect to VPN and verify it works
  Why: Confirm nftables rules don't break connectivity
  
  File: PHASE5-test-connection.sh
  Usage: bash PHASE5-test-connection.sh
  
  This will:
    â€¢ Attempt VPN connection
    â€¢ Wait for connection (up to 30 seconds)
    â€¢ Verify VPN IP is assigned
    â€¢ Show connection details
  
  Expected: Should connect without "Bad argument REJECT" errors

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Phase 6: VERIFY NO LEAKS (10 minutes)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  What: Run diagnostic tests and manual leak checks
  Why: Confirm kill switch and privacy protections work
  
  File: PHASE6-verify-leaks.sh
  Usage: bash PHASE6-verify-leaks.sh
  
  Tests include:
    â€¢ Comprehensive diagnostic
    â€¢ IP leak check (public IP vs VPN IP)
    â€¢ DNS configuration verification
    â€¢ WebRTC leak test (browser-based)
    â€¢ Kill switch test (optional - disconnects VPN)
  
  Critical tests:
    âœ“ Public IP must match VPN IP
    âœ“ DNS must resolve
    âœ“ Kill switch must block traffic when disconnected

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Phase 7: MONITOR STABILITY (24-48 hours)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  What: Monitor logs and watch for anomalies
  Why: Catch edge cases and confirm reliability
  
  Commands to run periodically:
  
  # Check PIA connection
  piactl get connectionstate
  piactl get vpnip
  
  # Check for firewall blocks
  sudo journalctl --since "1 hour ago" | grep "PIA-BLOCKED"
  
  # Check PIA daemon for errors
  sudo tail -50 /opt/piavpn/var/daemon.log
  
  # Check for IP leaks
  curl https://api.ipify.org
  
  Success criteria:
    âœ“ No disconnects in 24 hours
    âœ“ No IP leaks detected
    âœ“ No "Bad argument REJECT" errors in logs
    âœ“ System survives reboot with VPN still working

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EXECUTION ORDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. PHASE 0: âœ… COMPLETE (already done)

2. PHASE 1: Backup
   $ cd /path/to/VPN_TS_V2
   $ sudo bash PHASE1-backup.sh
   
3. PHASE 2: Routing Check
   $ bash PHASE2-routing-check.sh
   
4. PHASE 3: Configure PIA
   $ bash PHASE3-pia-config.sh
   
5. PHASE 4: Install nftables (REQUIRES SUDO)
   $ sudo bash PHASE4-nftables-install.sh
   
6. PHASE 5: Test Connection
   $ bash PHASE5-test-connection.sh
   
7. PHASE 6: Verify Leaks
   $ bash PHASE6-verify-leaks.sh
   
8. PHASE 7: Monitor (ongoing)
   $ # Run diagnostic commands periodically

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EMERGENCY RECOVERY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

If anything goes wrong and you lose network connectivity:

$ sudo /usr/local/bin/pia-emergency-recovery

This will:
  â€¢ Stop PIA service
  â€¢ Remove VPN interface
  â€¢ Flush firewall rules
  â€¢ Restore network connectivity
  â€¢ Provide recovery logs

Then use backed-up files to restore original state if needed.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TIMING SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Phases 1-6: ~52 minutes of active work
Phase 7:    24-48 hours of passive monitoring
Total:      ~2-3 days until fully verified

Breakdown:
  Phase 1: 5 minutes
  Phase 2: 2 minutes
  Phase 3: 2 minutes
  Phase 4: 15 minutes
  Phase 5: 5 minutes
  Phase 6: 10 minutes
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Total:   39 minutes (plus 24-48 hour monitoring)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

READY TO BEGIN?
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Your system is ready for Phase 1. Start with:

$ cd /path/to/VPN_TS_V2
$ sudo bash PHASE1-backup.sh

Then follow the phases in order.

Good luck! ðŸš€
EOF
